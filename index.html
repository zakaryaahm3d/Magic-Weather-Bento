<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Weather Bento</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- VARIABLES --- */
        :root {
            --sidebar-bg: rgba(15, 23, 42, 0.85);
            --card-bg: rgba(15, 23, 42, 0.75);
            --text-main: #ffffff;
            --text-dim: #cbd5e1;
            --accent: #8b5cf6;
            --purple-primary: 139, 92, 246;
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --overlay-color: rgba(0, 0, 0, 0.5);
        }

        [data-theme="light"] {
            --sidebar-bg: rgba(255, 255, 255, 0.9);
            --card-bg: rgba(255, 255, 255, 0.8);
            --text-main: #0f172a;
            --text-dim: #475569;
            --accent: #6366f1;
            --purple-primary: 99, 102, 241;
            --glass-border: 1px solid rgba(0, 0, 0, 0.1);
            --overlay-color: rgba(255, 255, 255, 0.2);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Inter', system-ui, sans-serif;
            color: var(--text-main);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background-color: #1e293b;
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease-in-out;
        }

            body::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: var(--overlay-color);
                backdrop-filter: blur(8px);
                z-index: -1;
            }

        .app {
            display: grid;
            grid-template-columns: 280px 1fr;
            height: 100%;
            position: relative;
        }

        /* SIDEBAR */
        .sidebar {
            background: var(--sidebar-bg);
            border-right: var(--glass-border);
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            backdrop-filter: blur(20px);
            z-index: 10;
            flex-shrink: 0;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .nav-item {
            padding: 12px 15px;
            border-radius: 12px;
            cursor: pointer;
            color: var(--text-dim);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.2s;
            border: 1px solid transparent;
        }

            .nav-item:hover, .nav-item.active {
                background: rgba(var(--purple-primary), 0.15);
                color: var(--text-main);
                border-color: rgba(var(--purple-primary), 0.4);
            }

            .nav-item i {
                width: 20px;
                text-align: center;
                font-size: 1.1em;
            }

        /* --- 3D MENU OVERLAY --- */
        #menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #050505;
            z-index: 9999;
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
            perspective: 1000px;
            overflow: hidden;
        }

            #menu-overlay.open {
                display: flex;
                opacity: 1;
                align-items: center;
                justify-content: center;
            }

        .sphere-scene {
            width: 0;
            height: 0;
            position: absolute;
            top: 50%;
            left: 50%;
            transform-style: preserve-3d;
        }

        .menu-item-3d {
            position: absolute;
            width: 110px;
            height: 110px;
            background: rgba(20, 20, 30, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            backface-visibility: visible;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            left: -55px;
            top: -55px;
            overflow: hidden;
        }

            .menu-item-3d.is-held {
                background: rgba(139, 92, 246, 0.8);
                border-color: #fff;
                box-shadow: 0 0 60px rgba(139, 92, 246, 0.9);
                z-index: 9999 !important;
            }

            .menu-item-3d img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                opacity: 0.6;
                filter: grayscale(100%);
                transition: 0.3s;
            }

            .menu-item-3d.is-held img {
                opacity: 1;
                filter: grayscale(0%);
            }

            .menu-item-3d span {
                position: absolute;
                font-weight: 900;
                font-size: 1.2rem;
                text-transform: uppercase;
                letter-spacing: 1px;
                text-align: center;
                color: #fff;
                text-shadow: 0 2px 10px rgba(0,0,0,1);
                pointer-events: none;
                opacity: 0;
                transform: scale(0.8);
                transition: 0.2s;
            }

            .menu-item-3d.is-held span {
                opacity: 1;
                transform: scale(1);
            }

        .close-menu {
            position: absolute;
            top: 30px;
            right: 30px;
            font-size: 2.5rem;
            color: white;
            cursor: pointer;
            z-index: 10001;
        }

        .menu-instruction {
            position: absolute;
            bottom: 50px;
            width: 100%;
            text-align: center;
            color: #666;
            letter-spacing: 2px;
            pointer-events: none;
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        /* Standard Controls */
        .search-container {
            position: relative;
        }

        .search-input {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: var(--glass-border);
            border-radius: 12px;
            padding: 12px 40px 12px 15px;
            color: var(--text-main);
            outline: none;
            transition: 0.3s;
        }

            .search-input:focus {
                border-color: var(--accent);
                box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
                background: rgba(255,255,255,0.1);
            }

        .search-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
        }

        select {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: var(--glass-border);
            border-radius: 12px;
            padding: 14px;
            color: var(--text-main);
            appearance: none;
            cursor: pointer;
            outline: none;
        }
            /* Fix for dark mode dropdowns */
            select option {
                background-color: #1e293b;
                color: #ffffff;
            }

        [data-theme="light"] select option {
            background-color: #ffffff;
            color: #0f172a;
        }

        .nav-header {
            font-size: 0.7rem;
            font-weight: 800;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 15px;
            margin-bottom: 5px;
        }

        .route-badge {
            display: block;
            padding: 10px 12px;
            margin-bottom: 6px;
            border-radius: 8px;
            background: rgba(255,255,255,0.03);
            border: var(--glass-border);
            color: var(--text-dim);
            cursor: pointer;
            transition: 0.2s;
            font-size: 0.85rem;
        }

            .route-badge:hover {
                background: rgba(var(--purple-primary), 0.2);
                color: var(--text-main);
                border-color: var(--accent);
                transform: translateX(5px);
            }

        .rank-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 5px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.9rem;
            cursor: pointer;
            transition: 0.2s;
        }

            .rank-item:hover {
                color: var(--accent);
                padding-left: 5px;
            }

        .theme-btn {
            margin-top: auto;
            padding: 12px;
            border: var(--glass-border);
            border-radius: 12px;
            color: var(--text-dim);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 600;
            transition: 0.3s;
            background: rgba(255,255,255,0.02);
        }

            .theme-btn:hover {
                background: rgba(255,255,255,0.1);
                color: var(--text-main);
            }

        /* --- LAYOUT --- */
        .main-container {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        .pages-wrapper {
            display: flex;
            width: 300%;
            height: 100%;
            transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .page {
            width: 33.333333%;
            flex: 0 0 33.333333%;
            height: 100%;
            padding: 30px 40px 100px 40px;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: 24px;
            perspective: 1000px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1.2fr 1.8fr;
            gap: 24px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }

        .grid-map {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 24px;
            min-height: 400px;
        }

        .grid-news {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .magic-bento-card {
            position: relative;
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            border-radius: 24px;
            padding: 24px;
            border: var(--glass-border);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out;
            --mouse-x: 50%;
            --mouse-y: 50%;
            /* --- FIXED: Allow Auto Height for Trip Planner --- */
            flex-shrink: 0;
            height: auto;
            min-height: fit-content;
        }

            .magic-bento-card::before {
                content: "";
                position: absolute;
                inset: 0;
                background: radial-gradient(800px circle at var(--mouse-x) var(--mouse-y), rgba(var(--purple-primary), 0.15), transparent 40%);
                opacity: 0;
                transition: opacity 0.5s;
                pointer-events: none;
                z-index: 1;
            }

            .magic-bento-card:hover::before {
                opacity: 1;
            }

            .magic-bento-card::after {
                content: "";
                position: absolute;
                inset: 0;
                border-radius: 24px;
                padding: 1.5px;
                background: radial-gradient(600px circle at var(--mouse-x) var(--mouse-y), rgba(var(--purple-primary), 0.8), transparent 40%);
                -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                -webkit-mask-composite: xor;
                mask-composite: exclude;
                opacity: 0;
                transition: opacity 0.5s;
                pointer-events: none;
                z-index: 2;
            }

            .magic-bento-card:hover::after {
                opacity: 1;
            }

        .card-content {
            position: relative;
            z-index: 5;
            width: 100%;
            /* --- FIXED: Let content grow --- */
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .city-name {
            font-size: 2.8rem;
            font-weight: 700;
            margin: 0;
            letter-spacing: -1px;
        }

        .temp-display {
            font-size: 6.5rem;
            font-weight: 800;
            line-height: 1;
            margin: 10px 0;
            color: var(--text-main);
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .condition-badge {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: rgba(var(--purple-primary), 0.2);
            color: var(--accent);
            padding: 8px 18px;
            border-radius: 50px;
            font-weight: 600;
            width: fit-content;
            font-size: 1.1rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .chart-btn {
            background: transparent;
            border: 1px solid var(--text-dim);
            color: var(--text-dim);
            padding: 6px 14px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: 0.2s;
        }

            .chart-btn.active {
                background: var(--accent);
                border-color: var(--accent);
                color: white;
            }

        .widget-label {
            font-size: 0.8rem;
            color: var(--text-dim);
            font-weight: 700;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }

        .widget-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .widget-sub {
            font-size: 0.9rem;
            color: var(--text-dim);
            margin-top: auto;
        }

        .compass-wrap {
            width: 80px;
            height: 80px;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: auto;
        }

        .compass-arrow {
            font-size: 2rem;
            color: var(--accent);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 0 8px var(--accent));
        }

        .forecast-item {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 20px;
            padding: 14px 0;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            align-items: center;
            font-size: 0.95rem;
        }

        .fc-day {
            font-weight: 600;
        }

        .fc-icon {
            width: 30px;
            text-align: center;
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 16px;
            opacity: 0.9;
        }

        .alert-row {
            display: flex;
            gap: 15px;
            align-items: flex-start;
            padding: 20px;
            border-radius: 16px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            margin-bottom: 15px;
            transition: 0.2s;
        }

            .alert-row:hover {
                background: rgba(239, 68, 68, 0.15);
                transform: translateX(5px);
            }

        .news-card-img {
            width: 100%;
            height: 140px;
            object-fit: cover;
            border-radius: 16px;
            margin-bottom: 15px;
            filter: brightness(0.8);
        }

        .news-date {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .news-title {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-main);
            margin-bottom: 5px;
            line-height: 1.3;
        }

        #alert-hub {
            position: fixed;
            top: 25px;
            right: 25px;
            width: 340px;
            z-index: 1000;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .alert-card {
            pointer-events: auto;
            animation: slideIn 0.4s ease-out;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Tools Styles */
        .route-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

            .route-controls select {
                flex-grow: 1;
                min-width: 140px;
            }

        .route-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-top: 10px;
            font-size: 1rem;
            transition: 0.2s;
        }

            .route-btn:hover {
                filter: brightness(1.1);
                transform: translateY(-2px);
            }

        .tool-display {
            text-align: center;
            padding: 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
        }

        .tool-big-val {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--text-main);
            margin-bottom: 8px;
        }

        .vs-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }

        .vs-mid {
            font-weight: 800;
            color: var(--accent);
            font-size: 1rem;
        }

        .activity-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .activity-input {
            flex-grow: 1;
            background: rgba(255,255,255,0.05);
            border: var(--glass-border);
            padding: 12px;
            border-radius: 12px;
            color: var(--text-main);
            outline: none;
        }

        .activity-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
        }

        .vs-input {
            width: 42%;
            background: rgba(255,255,255,0.05);
            border: var(--glass-border);
            border-radius: 12px;
            padding: 10px;
            color: var(--text-main);
            text-align: center;
            outline: none;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
        }

            ::-webkit-scrollbar-thumb:hover {
                background: rgba(255,255,255,0.3);
            }
    </style>
</head>
<body>

    <div id="menu-overlay">
        <div class="close-menu" onclick="toggle3DMenu(false)">&times;</div>
        <div class="sphere-scene" id="sphereScene"></div>
        <div class="menu-instruction">HOLD TO ZOOM &bull; RELEASE TO ROTATE</div>
    </div>

    <div id="alert-hub"></div>

    <div class="app">
        <div class="sidebar">
            <button class="route-btn" onclick="toggle3DMenu(true)" style="margin-bottom:20px; background:linear-gradient(45deg, var(--accent), #a855f7); box-shadow:0 4px 15px rgba(139, 92, 246, 0.4);">
                <i class="fas fa-cube"></i> Open 3D Menu
            </button>

            <div class="nav-menu">
                <div class="nav-item active" onclick="switchPage(0, this)"><i class="fas fa-home"></i> Dashboard</div>
                <div class="nav-item" onclick="switchPage(1, this)"><i class="fas fa-newspaper"></i> News & Alerts</div>
                <div class="nav-item" onclick="switchPage(2, this)"><i class="fas fa-tools"></i> Tools & Plan</div>
            </div>

            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="Search City..." onkeypress="handleEnter(event)">
                <button class="search-btn" onclick="searchCity()"><i class="fas fa-search"></i></button>
            </div>

            <div class="nav-header"><i class="fas fa-map-marker-alt"></i> Locations</div>
            <div class="select-wrapper">
                <select id="locationSelect" onchange="load(this.value)">
                </select>
            </div>

            <div class="nav-header"><i class="fas fa-route"></i> Routes</div>
            <div id="neighbors-list"></div>

            <div class="theme-btn" onclick="toggleTheme()">
                <i class="fas fa-adjust"></i> &nbsp; Switch Theme
            </div>
        </div>

        <div class="main-container">
            <div class="pages-wrapper" id="pageWrapper">

                <div class="page">
                    <div class="grid-2">
                        <div class="magic-bento-card">
                            <div class="card-content">
                                <h1 id="ui-city" class="city-name">Loading...</h1>
                                <div id="ui-temp" class="temp-display">--°</div>
                                <div class="condition-badge"><i class="fas fa-cloud" id="ui-icon"></i><span id="ui-cond">--</span></div>
                            </div>
                        </div>

                        <div class="magic-bento-card">
                            <div class="card-content">
                                <div class="chart-header">
                                    <div class="widget-label"><i class="fas fa-chart-line"></i> Temperature Trend</div>
                                    <div class="controls">
                                        <button class="chart-btn active" onclick="updateGraph('hourly', this)">24H</button>
                                        <button class="chart-btn" onclick="updateGraph('weekly', this)">Week</button>
                                        <button class="chart-btn" onclick="updateGraph('monthly', this)">Month</button>
                                        <button class="chart-btn" onclick="updateGraph('yearly', this)">Year</button>
                                    </div>
                                </div>
                                <div style="flex-grow:1; min-height:200px;"><canvas id="chart"></canvas></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid-3">
                        <div class="magic-bento-card">
                            <div class="card-content">
                                <div class="widget-label"><i class="fas fa-wind"></i> Wind Speed</div>
                                <div class="widget-value" id="ui-wind">--</div>
                                <div class="widget-sub">Normal Breeze</div>
                            </div>
                        </div>
                        <div class="magic-bento-card">
                            <div class="card-content">
                                <div class="widget-label"><i class="fas fa-tint"></i> Humidity</div>
                                <div class="widget-value" id="ui-hum">--</div>
                                <div class="widget-sub">Dew Point: 12°</div>
                            </div>
                        </div>
                        <div class="magic-bento-card">
                            <div class="card-content">
                                <div class="widget-label"><i class="fas fa-compass"></i> Direction</div>
                                <div class="compass-wrap">
                                    <i id="ui-arrow" class="fas fa-location-arrow compass-arrow"></i>
                                </div>
                            </div>
                        </div>
                        <div class="magic-bento-card">
                            <div class="card-content">
                                <div class="widget-label"><i class="fas fa-eye"></i> Visibility</div>
                                <div class="widget-value">20 km</div>
                                <div class="widget-sub">Clear View</div>
                            </div>
                        </div>
                        <div class="magic-bento-card">
                            <div class="card-content">
                                <div class="widget-label"><i class="fas fa-lungs"></i> Air Quality</div>
                                <div class="widget-value" id="ui-aqi">--</div>
                                <div class="widget-sub">US AQI</div>
                            </div>
                        </div>
                        <div class="magic-bento-card">
                            <div class="card-content">
                                <div class="widget-label"><i class="fas fa-cloud-rain"></i> Rainfall</div>
                                <div class="widget-value" id="ui-rain">--</div>
                                <div class="widget-sub">Last 24h</div>
                            </div>
                        </div>
                    </div>

                    <div class="grid-map">
                        <div class="magic-bento-card" style="padding:0;">
                            <div id="map"></div>
                        </div>
                        <div class="magic-bento-card">
                            <div class="card-content">
                                <div class="widget-label" style="margin-bottom:15px;"><i class="fas fa-calendar-alt"></i> 10-Day Forecast</div>
                                <div id="forecast" style="overflow-y:auto; padding-right:5px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="page">
                    <h2 style="margin:0 0 20px 0;"><i class="fas fa-exclamation-triangle" style="color:var(--accent)"></i> Active Alerts for <span id="news-city-name">Region</span></h2>
                    <div class="magic-bento-card" style="min-height:auto;">
                        <div class="card-content" id="alert-feed">
                            <div style="padding:20px; text-align:center; color:var(--text-dim)">Loading alerts...</div>
                        </div>
                    </div>

                    <h2 style="margin:30px 0 20px 0;"><i class="fas fa-newspaper" style="color:var(--accent)"></i> Weather News</h2>
                    <div class="grid-news" id="news-feed">
                        <div style="grid-column:1/-1; text-align:center; color:var(--text-dim)">Loading news...</div>
                    </div>
                </div>

                <div class="page">
                    <h2 style="margin:0 0 20px 0;"><i class="fas fa-map-marked-alt" style="color:var(--accent)"></i> Trip Planner</h2>

                    <div class="magic-bento-card">
                        <div class="card-content">
                            <div class="widget-label">Safest Weather Route</div>
                            <div class="route-controls">
                                <input id="routeStart" class="vs-input" list="cityList" placeholder="Start City">
                                <span style="font-weight:bold; color:var(--text-dim);"><i class="fas fa-arrow-right"></i></span>
                                <input id="routeEnd" class="vs-input" list="cityList" placeholder="End City">
                            </div>
                            <button class="route-btn" onclick="findRoute()">CALCULATE SAFEST ROUTE</button>

                            <div id="route-result" style="color:var(--text-main); font-weight:bold; text-align:center; padding:20px; border-top:1px solid rgba(255,255,255,0.1); margin-top:15px; min-height:80px; display:flex; align-items:center; justify-content:center; flex-wrap:wrap; gap:8px;">
                                Select cities to find the safest route.
                            </div>
                        </div>
                    </div>

                    <h2 style="margin:30px 0 20px 0;"><i class="fas fa-tasks" style="color:var(--accent)"></i> Activity Analysis</h2>
                    <div class="grid-2">
                        <div class="magic-bento-card">
                            <div class="card-content">
                                <div class="widget-label">Check Suitability</div>

                                <div class="activity-box">
                                    <input type="text" id="activityInput" class="activity-input" list="activityOptions" placeholder="e.g. Can I fly a drone today?">
                                    <datalist id="activityOptions">
                                        <option value="Can I fly a drone today?">
                                        <option value="Is it safe for a BBQ?">
                                        <option value="Can we play cricket?">
                                        <option value="Good for hiking?">
                                        <option value="Is it safe for construction work?">
                                        <option value="Can I go for a run?">
                                    </datalist>
                                    <button class="activity-btn" onclick="checkActivity()">Check</button>
                                </div>

                                <div class="tool-display">
                                    <div id="activity-score" class="tool-big-val">--</div>
                                    <div id="activity-msg" style="color:var(--text-dim)">Type an activity above</div>
                                </div>
                            </div>
                        </div>

                        <div class="magic-bento-card">
                            <div class="card-content">
                                <div class="widget-label">City Comparator</div>
                                <div class="vs-container">
                                    <input id="vsCity1" class="vs-input" list="cityList" placeholder="City 1">
                                    <span class="vs-mid">VS</span>
                                    <input id="vsCity2" class="vs-input" list="cityList" placeholder="City 2">
                                </div>
                                <button class="route-btn" style="background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2);" onclick="compareCities()">COMPARE</button>
                                <div id="vs-result" style="margin-top:15px; font-size:0.9rem; color:var(--text-dim); text-align:center;">Click compare to see details.</div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <datalist id="cityList"></datalist>

    <script>
        // --- 3D MENU LOGIC ---
        const menuData = [
            { title: 'DASH', page: 0, img: 'https://images.unsplash.com/photo-1592210454359-9043f067919b?w=200&q=80' },
            { title: 'NEWS', page: 1, img: 'https://images.unsplash.com/photo-1504608524841-42fe6f032b4b?w=200&q=80' },
            { title: 'TOOLS', page: 2, img: 'https://images.unsplash.com/photo-1581093450021-4a7360e9a6b5?w=200&q=80' },
            { title: 'DASH', page: 0, img: 'https://images.unsplash.com/photo-1590055531615-f16d36ffe8ec?w=200&q=80' },
            { title: 'NEWS', page: 1, img: 'https://images.unsplash.com/photo-1504198266287-1659872e6590?w=200&q=80' },
            { title: 'TOOLS', page: 2, img: 'https://images.unsplash.com/photo-1580196969807-cc6de06c05be?w=200&q=80' },
            { title: 'DASH', page: 0, img: 'https://images.unsplash.com/photo-1524661135-423995f22d0b?w=200&q=80' },
            { title: 'NEWS', page: 1, img: 'https://images.unsplash.com/photo-1565793298595-6a879b1d9492?w=200&q=80' },
            { title: 'TOOLS', page: 2, img: 'https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=200&q=80' },
            { title: 'DASH', page: 0, img: 'https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?w=200&q=80' },
            { title: 'NEWS', page: 1, img: 'https://images.unsplash.com/photo-1534274988754-c6a60bf93c17?w=200&q=80' },
            { title: 'TOOLS', page: 2, img: 'https://images.unsplash.com/photo-1530908295418-a12e326966ba?w=200&q=80' }
        ];

        let sphereRotation = { x: 0, y: 0 };
        let targetRotation = { x: 0, y: 0 };
        let animationFrame;
        let heldItemIndex = -1;

        function init3DMenu() {
            const scene = document.getElementById('sphereScene');
            scene.innerHTML = '';
            const count = menuData.length;
            const phi = Math.PI * (3 - Math.sqrt(5));
            const radius = 220;

            for (let i = 0; i < count; i++) {
                const y = 1 - (i / (count - 1)) * 2;
                const r = Math.sqrt(1 - y * y);
                const theta = phi * i;

                const x = Math.cos(theta) * r;
                const z = Math.sin(theta) * r;

                const el = document.createElement('div');
                el.className = 'menu-item-3d';
                el.innerHTML = `
                    <img src="${menuData[i].img}" alt="">
                    <span>${menuData[i].title}</span>
                `;

                el.onmousedown = () => startHold(i);
                el.onmouseup = () => endHold(i);
                el.onmouseleave = () => endHold(i);
                el.onclick = () => { if (heldItemIndex === -1) selectMenu(menuData[i].page); };

                el.ontouchstart = (e) => { e.preventDefault(); startHold(i); };
                el.ontouchend = () => endHold(i);

                el.dataset.x = x * radius;
                el.dataset.y = y * radius;
                el.dataset.z = z * radius;
                el.dataset.index = i;

                el.dataset.currentScale = 1.0;

                scene.appendChild(el);
            }
            updateSphere();
        }

        function startHold(index) {
            heldItemIndex = index;
            const items = document.querySelectorAll('.menu-item-3d');
            items[index].classList.add('is-held');
        }

        function endHold(index) {
            if (heldItemIndex === index) {
                heldItemIndex = -1;
                const items = document.querySelectorAll('.menu-item-3d');
                items[index].classList.remove('is-held');
            }
        }

        function updateSphere() {
            if (heldItemIndex === -1) {
                sphereRotation.x += (targetRotation.x - sphereRotation.x) * 0.05;
                sphereRotation.y += (targetRotation.y - sphereRotation.y) * 0.05;
            }

            const items = document.querySelectorAll('.menu-item-3d');
            const cx = Math.cos(sphereRotation.x);
            const sx = Math.sin(sphereRotation.x);
            const cy = Math.cos(sphereRotation.y);
            const sy = Math.sin(sphereRotation.y);

            items.forEach((item, i) => {
                let x = parseFloat(item.dataset.x);
                let y = parseFloat(item.dataset.y);
                let z = parseFloat(item.dataset.z);

                let rx = x * cy - z * sy;
                let rz = x * sy + z * cy;
                x = rx; z = rz;

                let ry = y * cx - z * sx;
                rz = y * sx + z * cx;
                y = ry; z = rz;

                let baseScale = (z + 400) / 400;
                let alpha = (z + 300) / 600;

                let targetScale = baseScale;
                if (i === heldItemIndex) {
                    targetScale = 2.5;
                    z = 200;
                }

                let current = parseFloat(item.dataset.currentScale);
                current += (targetScale - current) * 0.1;
                item.dataset.currentScale = current;

                item.style.transform = `translate3d(${x}px, ${y}px, ${z}px) scale(${current})`;
                item.style.opacity = alpha < 0 ? 0 : alpha;
                item.style.zIndex = Math.floor(z);
            });

            animationFrame = requestAnimationFrame(updateSphere);
        }

        function toggle3DMenu(show) {
            const overlay = document.getElementById('menu-overlay');
            if (show) {
                overlay.classList.add('open');
                init3DMenu();
                window.addEventListener('mousemove', onMouseMove);
            } else {
                overlay.classList.remove('open');
                cancelAnimationFrame(animationFrame);
                window.removeEventListener('mousemove', onMouseMove);
            }
        }

        function onMouseMove(e) {
            if (heldItemIndex !== -1) return;
            const x = (e.clientX - window.innerWidth / 2) / window.innerWidth;
            const y = (e.clientY - window.innerHeight / 2) / window.innerHeight;
            targetRotation.y = x * 2.5;
            targetRotation.x = -y * 2.5;
        }

        function selectMenu(pageIdx) {
            toggle3DMenu(false);
            switchPage(pageIdx, document.querySelectorAll('.nav-item')[pageIdx]);
        }

        // --- STANDARD APP LOGIC ---
        let map, marker, chart;
        let currentTemp = 10, currentCond = "Clear", lat = 34.07, lon = 72.63;
        let currentCity = "Topi";
        let isDark = true;
        let cachedData = {};

        window.onload = () => {
            initMap();
            populateCities();
            initMagicBento();
        };

        function switchPage(pageIndex, btn) {
            document.getElementById('pageWrapper').style.transform = `translateX(-${pageIndex * 33.333333}%)`;
            if (btn) {
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                btn.classList.add('active');
            }
        }

        function initMagicBento() {
            const cards = document.querySelectorAll('.magic-bento-card');
            cards.forEach(card => {
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    card.style.setProperty('--mouse-x', `${x}px`);
                    card.style.setProperty('--mouse-y', `${y}px`);
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    const rotateX = ((y - centerY) / centerY) * -4;
                    const rotateY = ((x - centerX) / centerX) * 4;
                    card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.01)`;
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = `perspective(1000px) rotateX(0deg) rotateY(0deg) scale(1)`;
                });
            });
        }

        async function fetchCityNews(city) {
            try {
                const encodedCity = encodeURIComponent(city);
                const res = await fetch(`/news?city=${encodedCity}`);
                const news = await res.json();
                renderNewsPage(news);
            } catch (e) { console.log("News fetch failed", e); }
        }

        async function populateCities() {
            try {
                const res = await fetch('/cities');
                const cities = await res.json();
                const select = document.getElementById('locationSelect');
                const dataList = document.getElementById('cityList');

                select.innerHTML = '';
                dataList.innerHTML = '';

                cities.forEach(city => {
                    const opt = document.createElement('option');
                    opt.value = city;
                    opt.innerText = city;
                    select.appendChild(opt);

                    const opt2 = document.createElement('option');
                    opt2.value = city;
                    dataList.appendChild(opt2);
                });

                load('Topi');
            } catch (e) { console.log("Failed to fetch cities", e); }
        }

        function getNewsImage(keyword) {
            const k = keyword.toLowerCase();
            if (k.includes("fog") || k.includes("visibility") || k.includes("smog")) return "https://images.unsplash.com/photo-1541122678632-15f013444b04?w=600&q=80";
            if (k.includes("rain") || k.includes("flood")) return "https://images.unsplash.com/photo-1519692933481-e162a57d6721?w=600&q=80";
            if (k.includes("storm") || k.includes("thunder")) return "https://images.unsplash.com/photo-1605727216801-e27ce1d0cc28?w=600&q=80";
            if (k.includes("snow") || k.includes("freeze") || k.includes("ice")) return "https://images.unsplash.com/photo-1477601263568-180e2c6d046e?w=600&q=80";
            if (k.includes("sun") || k.includes("heat") || k.includes("clear")) return "https://images.unsplash.com/photo-1601297183305-6df142704ea2?w=600&q=80";
            if (k.includes("wind")) return "https://images.unsplash.com/photo-1465056836041-7f43ac27dcb5?w=600&q=80";
            return "https://images.unsplash.com/photo-1592210454359-9043f067919b?w=600&q=80";
        }

        function renderNewsPage(news) {
            const feed = document.getElementById('news-feed');
            if (news && news.length > 0) {
                feed.innerHTML = news.map((item, i) => {
                    const imgUrl = getNewsImage(item.headline + " " + item.category);
                    return `
                    <div class="magic-bento-card" style="min-height:auto;">
                        <div class="card-content">
                            <img src="${imgUrl}" class="news-card-img" alt="Weather News"
                                 onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1592210454359-9043f067919b?w=600&q=80';">
                            <div class="news-date">LIVE UPDATE - ${item.city}</div>
                            <div class="news-title">${item.headline}</div>
                        </div>
                    </div>`;
                }).join('');
                initMagicBento();
            } else {
                feed.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:var(--text-dim)">No significant news for this region.</div>`;
            }
        }

        function updateDynamicBackground(cond) {
            let url = "";
            let c = cond.toLowerCase();
            if (c.includes("snow")) url = "https://images.unsplash.com/photo-1477601263568-180e2c6d046e?q=80&w=1920";
            else if (c.includes("rain")) url = "https://images.unsplash.com/photo-1519692933481-e162a57d6721?auto=format&fit=crop&q=80&w=1920";
            else if (c.includes("partly")) url = "https://images.unsplash.com/photo-1513002749550-c59d786b8e6c?auto=format&fit=crop&q=80&w=1920";
            else if (c.includes("cloud")) url = "https://images.unsplash.com/photo-1534088568595-a066f410bcda?auto=format&fit=crop&q=80&w=1920";
            else if (c.includes("hot") || c.includes("sun") || c.includes("scorching")) url = "https://images.unsplash.com/photo-1601297183305-6df142704ea2?auto=format&fit=crop&q=80&w=1920";
            else if (c.includes("wind")) url = "https://images.unsplash.com/photo-1465056836041-7f43ac27dcb5?auto=format&fit=crop&q=80&w=1920";
            else url = "https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?auto=format&fit=crop&q=80&w=1920";
            document.body.style.backgroundImage = `url('${url}')`;
        }

        async function load(name) {
            document.getElementById('locationSelect').value = name;
            currentCity = name;
            document.getElementById('news-city-name').innerText = name;

            try {
                const encodedName = encodeURIComponent(name);
                const res = await fetch(`/data?city=${encodedName}`);
                const data = await res.json();

                if (data.city) {
                    cachedData = data;
                    currentTemp = data.current.temperature_2d;
                    currentCond = data.current.condition;
                    lat = data.lat; lon = data.lon;

                    document.getElementById('ui-city').innerText = data.city;
                    document.getElementById('ui-temp').innerText = currentTemp + "°";
                    document.getElementById('ui-cond').innerText = currentCond;
                    document.getElementById('ui-wind').innerText = data.current.wind_speed_10m + " km/h";
                    document.getElementById('ui-hum').innerText = data.current.relative_humidity_2d + "%";
                    document.getElementById('ui-aqi').innerText = data.current.aqi;
                    document.getElementById('ui-rain').innerText = data.current.rain + " mm";

                    document.getElementById('ui-arrow').style.transform = `rotate(${data.current.wind_dir - 45}deg)`;

                    const icon = document.getElementById('ui-icon');
                    icon.className = currentCond.includes("Rain") ? "fas fa-cloud-showers-heavy" :
                        currentCond.includes("Sun") || currentCond.includes("Clear") ? "fas fa-sun" : "fas fa-cloud";

                    updateDynamicBackground(currentCond);
                    updateMap(data.city);
                    updateGraph('hourly', null);
                    renderForecast(data.forecast);
                    renderNeighbors(data.neighbors);
                    renderAlertsPage(data.alerts);

                    fetchCityNews(name);
                }
            } catch (e) { console.log("Data Load Error", e); }
        }

        async function findRoute() {
            let start = document.getElementById('routeStart').value.trim();
            let end = document.getElementById('routeEnd').value.trim();

            // Capitalize logic
            if (start) start = start[0].toUpperCase() + start.slice(1).toLowerCase();
            if (end) end = end[0].toUpperCase() + end.slice(1).toLowerCase();

            if (!start || !end) return;

            try {
                const encStart = encodeURIComponent(start);
                const encEnd = encodeURIComponent(end);
                const res = await fetch(`/route?start=${encStart}&end=${encEnd}`);
                const data = await res.json();
                const resultDiv = document.getElementById('route-result');

                if (data.path && data.path.length > 0) {
                    resultDiv.innerHTML = `Safest Route: <br><span style="color:var(--accent); font-size:1.2rem; margin-top:8px; display:inline-block;">${data.path.join(" <i class='fas fa-arrow-right'></i> ")}</span>`;
                } else {
                    resultDiv.innerHTML = "<span style='color:#ef4444'>No safe route found between these cities.</span>";
                }
            } catch (e) { console.log("Route Error", e); }
        }

        async function checkActivity() {
            const activity = document.getElementById('activityInput').value.trim();
            if (!activity) return;

            const scoreDiv = document.getElementById('activity-score');
            const msgDiv = document.getElementById('activity-msg');

            scoreDiv.innerHTML = "<i class='fas fa-spinner fa-spin' style='font-size:1.5rem'></i>";

            try {
                const encodedActivity = encodeURIComponent(activity);
                const encodedCity = encodeURIComponent(currentCity);

                const res = await fetch(`/predict?city=${encodedCity}&activity=${encodedActivity}`);
                const data = await res.json();

                scoreDiv.innerText = data.score;
                scoreDiv.style.color = data.color;
                msgDiv.innerText = data.message;
            } catch (e) {
                scoreDiv.innerText = "Error";
                msgDiv.innerText = "Could not predict.";
            }
        }

        async function compareCities() {
            let c1 = document.getElementById('vsCity1').value.trim();
            let c2 = document.getElementById('vsCity2').value.trim();
            const resDiv = document.getElementById('vs-result');

            if (!c1 || !c2) return;

            // Capitalize for backend safety
            c1 = c1[0].toUpperCase() + c1.slice(1).toLowerCase();
            c2 = c2[0].toUpperCase() + c2.slice(1).toLowerCase();

            resDiv.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Fetching Data...";

            try {
                const r1 = await fetch(`/data?city=${encodeURIComponent(c1)}`).then(r => r.json());
                const r2 = await fetch(`/data?city=${encodeURIComponent(c2)}`).then(r => r.json());

                if (!r1.city || !r2.city) {
                    resDiv.innerHTML = "<span style='color:#ef4444'>One or both cities not found.</span>";
                    return;
                }

                const t1Color = r1.current.temperature_2d > r2.current.temperature_2d ? '#ef4444' : '#fff';
                const t2Color = r2.current.temperature_2d > r1.current.temperature_2d ? '#ef4444' : '#fff';

                resDiv.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-top:20px; align-items:center;">
                        <div style="text-align:center; flex:1;">
                            <div style="font-weight:bold; color:var(--text-dim); margin-bottom:5px;">${r1.city}</div>
                            <div style="font-size:1.8rem; font-weight:800; color:${t1Color}">${r1.current.temperature_2d}°</div>
                            <div style="font-size:0.85rem; opacity:0.8">${r1.current.condition}</div>
                            <div style="font-size:0.8rem; color:var(--accent); margin-top:4px;">${r1.current.wind_speed_10m} km/h</div>
                        </div>
                        <div style="font-weight:900; color:var(--text-dim); font-size:1.2rem; opacity:0.5;">VS</div>
                        <div style="text-align:center; flex:1;">
                            <div style="font-weight:bold; color:var(--text-dim); margin-bottom:5px;">${r2.city}</div>
                            <div style="font-size:1.8rem; font-weight:800; color:${t2Color}">${r2.current.temperature_2d}°</div>
                            <div style="font-size:0.85rem; opacity:0.8">${r2.current.condition}</div>
                            <div style="font-size:0.8rem; color:var(--accent); margin-top:4px;">${r2.current.wind_speed_10m} km/h</div>
                        </div>
                    </div>
                `;
            } catch (e) { resDiv.innerHTML = "Comparison Failed."; }
        }

        function renderAlertsPage(alerts) {
            const feed = document.getElementById('alert-feed');
            if (alerts && alerts.length > 0) {
                feed.innerHTML = alerts.map(msg => `
                    <div class="alert-row">
                        <div style="font-size:1.5rem; color:#ef4444;"><i class="fas fa-exclamation-circle"></i></div>
                        <div><div style="font-weight:700; color:#ef4444; margin-bottom:4px;">CRITICAL ALERT</div><div style="color:var(--text-main);">${msg}</div></div>
                    </div>`).join('');
            } else {
                feed.innerHTML = `<div style="padding:20px; text-align:center; color:var(--text-dim)">No active alerts for this city.</div>`;
            }
        }

        function updateGraph(mode, btn) {
            if (btn) { document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
            const ctx = document.getElementById('chart').getContext('2d');
            let data = [], labels = [];
            let m = mode.toLowerCase();

            if (m === 'hourly' || m === '24h') { data = cachedData.hourly || []; labels = Array.from({ length: data.length }, (_, i) => `${i}:00`); }
            else if (m === 'weekly' || m === 'week') { data = cachedData.weekly || []; labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']; }
            else if (m === 'monthly' || m === 'month') { data = cachedData.monthly || []; labels = Array.from({ length: data.length }, (_, i) => `${i + 1}`); }
            else if (m === 'yearly' || m === 'year') { data = cachedData.yearly || []; labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']; }

            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [{ data: data, borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.2)', borderWidth: 3, fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#94a3b8' } }, y: { display: false } } }
            });
        }

        function initMap() { map = L.map('map', { zoomControl: false, attributionControl: false }).setView([lat, lon], 10); L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map); }
        function updateMap(title) { map.setView([lat, lon], 10); if (marker) map.removeLayer(marker); marker = L.marker([lat, lon]).addTo(map).bindPopup(title).openPopup(); }
        function renderForecast(fc) { const list = document.getElementById('forecast'); if (fc) list.innerHTML = fc.map(d => `<div class="forecast-item"><div class="fc-day">${d.day}</div><div class="fc-icon" style="color:#60a5fa"><i class="fas fa-tint"></i> ${d.rain_prob}%</div><div class="fc-icon" style="color:#fbbf24"><i class="fas ${d.cond.includes('Rain') ? 'fa-cloud-rain' : 'fa-sun'}"></i></div><div style="font-weight:700; text-align:right;">${d.high}° <span style="font-weight:400; color:var(--text-dim)">${d.low}°</span></div></div>`).join(''); }
        function renderNeighbors(n) { const list = document.getElementById('neighbors-list'); if (n) list.innerHTML = n.map(x => `<span class="route-badge" onclick="load('${x}')">${x} <i class="fas fa-arrow-right" style="font-size:0.7em"></i></span>`).join(''); }
        function toggleTheme() { isDark = !isDark; if (isDark) document.body.removeAttribute('data-theme'); else document.body.setAttribute('data-theme', 'light'); updateDynamicBackground(currentCond); }
        function handleEnter(e) { if (e.key === 'Enter') searchCity(); }
        function searchCity() { let v = document.getElementById('searchInput').value.trim(); if (v) { v = v[0].toUpperCase() + v.slice(1).toLowerCase(); load(v); document.getElementById('searchInput').value = ''; } }
    </script>
</body>
</html>